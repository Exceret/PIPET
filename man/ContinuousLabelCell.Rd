% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/16_LabelCells.R
\name{ContinuousLabelCell}
\alias{ContinuousLabelCell}
\title{Label Cells Using Continuous Phenotype Scoring from PIPET}
\usage{
ContinuousLabelCell(
  res_df,
  group_prefix = "PIPET_dist_",
  pval_col = "PIPET_Pvalue",
  fdr_col = "PIPET_FDR",
  alpha = 0.05,
  lambda = NULL
)
}
\arguments{
\item{res_df}{A data frame containing:
\itemize{
\item Distance columns named like \code{paste0(group_prefix, <id>)}, e.g.
\code{"PIPET_dist_1"}, \code{"PIPET_dist_2"}, ...
\item A p-value column (e.g., \code{"PIPET_Pvalue"})
\item An FDR column (e.g., \code{"PIPET_FDR"})
}}

\item{group_prefix}{Character string prefix used to identify distance columns.
Default: \code{"PIPET_dist_"}.}

\item{pval_col}{Name of the column containing raw p-values (used only for significance flagging).}

\item{fdr_col}{Name of the column containing FDR-adjusted p-values. Cells with
\code{res_df\[\[fdr_col\]\] <= alpha} are considered statistically significant.}

\item{alpha}{Significance threshold for FDR. Default: \code{0.05}.}

\item{lambda}{Smoothing parameter for distance-to-weight conversion:
\eqn{w_{ik} = \exp(-\lambda \cdot d_{ik})}. Controls how sharply distances decay
into weights. If \code{NULL} (default), \code{lambda} is auto-tuned so that the
median ratio of best-to-second-best weight is ~5 (empirically balances specificity
and robustness). Clamped to \code{[2, 50]}.}
}
\value{
A copy of \code{res_df} with three new columns added:
\describe{
\item{\code{PIPET_phenotype_score}}{Continuous barycentric score \eqn{s_i \in [\min(k), \max(k)]},
where higher values indicate stronger alignment with higher-indexed groups.}
\item{\code{PIPET_match_confidence}}{Per-cell confidence:
\eqn{\mathrm{plogis}(\lambda \cdot \Delta d_i) \cdot \mathbb{I}(FDR \le \alpha)},
where \eqn{\Delta d_i} = gap between 1st and 2nd smallest distances. Ranges in \eqn{[0, 1]}.}
\item{\code{PIPET}}{Categorical label: \code{"Positive"}, \code{"Negative"}, or \code{"Neutral"}.}
}
}
\description{
Assigns each cell a categorical label (\code{"Positive"}, \code{"Negative"}, or \code{"Neutral"})
based on a continuous phenotype score derived from weighted barycentric projection
onto reference group centroids (i.e. PIPET score). The score is smoothed via kernel density estimation (KDE),
and thresholds are adaptively inferred from bimodality (valleys) or spread statistics.
Significance (via FDR-corrected p-values) gates confident assignments.

Intended for outputs from proximity-inference tools (e.g., PIPET-style pipelines),
where multiple distance columns encode dissimilarity to pre-defined reference groups.
}
\section{Labeling Logic}{

\itemize{
\item \strong{Positive}: Significant (\code{FDR <= alpha}) AND score > \code{thresh_high}
\item \strong{Negative}: Significant AND score < \code{thresh_low}
\item \strong{Neutral}: Otherwise (non-significant or intermediate score)
}

Thresholds \code{thresh_low} / \code{thresh_high} are inferred hierarchically:
\enumerate{
\item If KDE of significant scores is clearly bimodal (\eqn{\ge 2} valleys),
use leftmost and rightmost valley positions.
\item If unimodal (1 valley), use \eqn{\text{valley} \pm \mathrm{MAD}}.
\item If no valleys detected, fall back to 25th/75th percentiles of significant scores.
}
}

\examples{
# Simulate 3 reference groups (e.g., anterior/mid/posterior)
set.seed(42)
n_cells <- 200
dist_mat <- matrix(rexp(n_cells * 3, rate = 0.5), ncol = 3)
colnames(dist_mat) <- c("PIPET_dist_1", "PIPET_dist_2", "PIPET_dist_3")
pvals <- runif(n_cells, 0, 0.1)
fdrs <- p.adjust(pvals, "BH")
res_df <- data.frame(dist_mat, PIPET_Pvalue = pvals, PIPET_FDR = fdrs)

labeled <- ContinuousLabelCell(res_df)
table(labeled$PIPET)
head(labeled[, c("PIPET_phenotype_score", "PIPET_match_confidence", "PIPET")])

}
